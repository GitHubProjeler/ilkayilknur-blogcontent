# BenchmarkDotNet ile Performans ve Memory Benchmarking #

Bir ürün geliştirirken ne kadar dikkat ediyoruz bilmiyorum ama geliştirdiğimiz uygulamanın en önemli özelliklerinden biri de hiç kuşkusuz ki uygulamanın performansı. Kimi zaman "***abi önce çalışsın, sonra performansa bakarız***" dedikten sonra ne yazık ki o "*sonra*" hiçbir zaman gelmiyor taa ki müşteriden bir şikayet alana yada  out of memory exception gelene kadar :D

Bu yazıda sizlere benim de arada kullandığım bir benchmarking aracı olan [DotNetBenchmark](https://github.com/PerfDotNet/BenchmarkDotNet)'tan bahsedeceğim. Yukarıda bahsettiğim gibi müşteriden bir şikayet veya exceptionlar almadığımız sürece bu performans veya memory kullanımı olaylarına pek bakmayız. Ama bunlar geldiği zaman da kodların aralarına Stopwatch'lar koyarak süreleri veya memory'i ölçmeye çalışırız. Bu sırada yazdığımız kod da kirlenir vs.. sonra bir de bu ölçüm yaptığımız kodları toparlamak gerekir, zorlanırız. Ayrıca da ölçüm için doğru yöntemleri kullandığımızdan emin olmamız gerekiyor. BenchmarkDotNet aracı işte tüm bu pis işleri de kendisi doğru bir şekilde halletiği için de oldukça güzel bir tool. Şimdi gelelim bu toolu nasıl kullanacağımıza. 

İlk olarak BenchmarkDotNet librarysini aşağıdaki komutla Nuget paketi olarak projenize ekleyebilirsiniz.

    PS> Install-Package BenchmarkDotNet

Projenize paketi ekledikten sonra artık herşey oldukça basit. Şimdi diyelim ki bir liste üzerinde LINQ sorgusu ile normal for döngüsünü karşılaştırmak istiyorsunuz. Aşağıdaki gibi basit bir class içerisinde aynı sorguyu hem LINQ ile hem de for döngüsü ile yazıyoruz. Daha sonra yapmamız gereken şey ise  metotları **Benchmark attribute'ü** ile işaretlemek.

<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">LINQvsFor</span><br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;list&nbsp;=&nbsp;<span style="color:#2b91af;">Enumerable</span>.Range(1,&nbsp;2000).Select(t&nbsp;=&gt;&nbsp;t&nbsp;+&nbsp;<span style="color:#a31515;">&quot;name&quot;</span>).ToList();<br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Benchmark</span>]<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;For()<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;retVal&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;();<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;(<span style="color:blue;">int</span>&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;list.Count;&nbsp;i++)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(list[i].Contains(<span style="color:#a31515;">&quot;1&quot;</span>))<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retVal.Add(list[i]);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;retVal;<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Benchmark</span>]<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;LINQ()<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;list.Where(t&nbsp;=&gt;&nbsp;t.Contains(<span style="color:#a31515;">&quot;1&quot;</span>)).ToList();<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</pre>

Daha sonra **BenchmarkRunner** sınıfını kullanarak bir console app üzerinde bu testi çalıştırıp sonucunu hızlı bir şekilde görebiliriz. Tabi sonuçları en doğru şekilde alabilmek için testi **Release modda** çalıştırmayı unutmamak gerekiyor :)

<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">Program</span><br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Main(<span style="color:blue;">string</span>[]&nbsp;args)<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">BenchmarkRunner</span>.Run&lt;<span style="color:#2b91af;">LINQvsFor</span>&gt;();<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</pre>

![](https://ilkayblog.blob.core.windows.net/uploads/2016/07/forvslinqreport.png)

Benchmark testlerini çalıştırdıktan sonra çıktıları pek çok farklı formatta(Markdown,CSV) vs.. alabilmemiz mümkün.
Bunun için basit bir config sınıfı yazıp benchmarkı çalıştırırken configi parametre olarak geçmemiz gerekiyor. Örneğin Markdown olarak export almak istersek...

<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">Program</span><br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Main(<span style="color:blue;">string</span>[]&nbsp;args)<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">BenchmarkRunner</span>.Run&lt;<span style="color:#2b91af;">LINQvsFor</span>&gt;();<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}<br/> <br/><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">Config</span>&nbsp;:&nbsp;<span style="color:#2b91af;">ManualConfig</span><br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;Config()<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add(<span style="color:#2b91af;">MarkdownExporter</span>.Default);<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</pre>

Benchmark testlerimizi belirli parametre kombinasyonlarında da çalıştırmamız mümkün. Bunun için ilgili fieldı **Params** attribute'ü ile işaretleyip alacağı değerleri belirtmemiz yeterli.

Örneğin,
<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">StringConcatTest</span><br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Params</span>(1,&nbsp;2,&nbsp;3,&nbsp;4,&nbsp;5,&nbsp;10,&nbsp;100,&nbsp;1000)]<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">int</span>&nbsp;loops;<br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Benchmark</span>]<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;StringConcat()<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;result&nbsp;=&nbsp;<span style="color:blue;">string</span>.Empty;<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;(<span style="color:blue;">int</span>&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;loops;&nbsp;++i)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;<span style="color:blue;">string</span>.Concat(result,&nbsp;i.ToString());<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;result;<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Benchmark</span>]<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;StringBuilder()<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">StringBuilder</span>&nbsp;sb&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">StringBuilder</span>(<span style="color:blue;">string</span>.Empty);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">for</span>&nbsp;(<span style="color:blue;">int</span>&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;loops;&nbsp;++i)<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sb.Append(i.ToString());<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;sb.ToString();<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</pre>

Yukarıdaki testler Params attribute'ünde belirttiğimiz parametreler için teker çalıştırılacak. Sonuçlarını da belirtilen her parametre için ayrı ayrı alacağız. 

![](https://ilkayblog.blob.core.windows.net/uploads/2016/07/stringconcatreport.png)

Kodunuzun ne kadar memory kullandığı ile ilgili analiz yapmak isterseniz de öncelikli olarak bir ek nuget paketini daha projenize eklemeniz gerekiyor. 

    PS> Install-Package BenchmarkDotNet.Diagnostics.Windows

Bu paketi de ekledikten sonra aşağıdaki gibi MemoryDiagnoser ekleyerek memory kullanımı ile ilgili sonuçları da elde edebiliriz. 

<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">Program</span><br/>{<br/>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Main(<span style="color:blue;">string</span>[]&nbsp;args)<br/>&nbsp;&nbsp;&nbsp;&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;config&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">ManualConfig</span>();<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.Add(<span style="color:#2b91af;">DefaultConfig</span>.Instance);<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.Add(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">MemoryDiagnoser</span>());<br/> <br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">BenchmarkRunner</span>.Run&lt;<span style="color:#2b91af;">StringConcatTest</span>&gt;(config);<br/>&nbsp;&nbsp;&nbsp;&nbsp;}<br/>}</pre>

Uygulamayı çalıştırdığımızda...

![](https://ilkayblog.blob.core.windows.net/uploads/2016/07/stringconcatmemoryreport.png)

Gördüğünüz gibi **BenchmarkDotNet** toolu oldukça kuvvetli bir tool. Bu yazıda bahsedemeyeceğim pek çok farklı özelliği de ayrıca içerisinde barındırmakta. Örneğin testlerini belirli [ortamlar](https://github.com/PerfDotNet/BenchmarkDotNet#jobs) için çalıştırabiliyorsunuz. Bir testi [base](https://github.com/PerfDotNet/BenchmarkDotNet#baseline) olarak alıp diğer testlerin sonuçlarını ona göre karşılatırabilmeniz de mümkün. Projenin temel amacı benchmarkingi kolay ve güvenilir olarak yapmak olduğu için aslında oldukça complex testleri hızlı bir şekilde 1-2 ufak değişiklikle yapabiliyorsunuz. Bu nedenle testlere başlamadan önce projenin [readme](https://github.com/PerfDotNet/BenchmarkDotNet/blob/stable/README.md) sayfasını okumanızı tavsiye ederim. 

Projenin Github reposunda ek olarak pekçok örnek benchmark testleri de bulunmakta. Yukarıda kullandığım string concat testi de dahil olmak üzere bu testler için de [https://github.com/PerfDotNet/BenchmarkDotNet/tree/stable/BenchmarkDotNet.Samples](https://github.com/PerfDotNet/BenchmarkDotNet/tree/stable/BenchmarkDotNet.Samples) klasörüne bakabilirsiniz.

Benchmark olayı kritik bir konu olduğu için projenin kullanıldığı yerlerin referanslarına da [https://github.com/PerfDotNet/BenchmarkDotNet/wiki/People-using-BenchmarkDotNet](https://github.com/PerfDotNet/BenchmarkDotNet/wiki/People-using-BenchmarkDotNet) adresinden ulaşabilirsiniz. Proje ile ilgili daha detaylı bilgiye de projenin contributerlarından olan [Matt Warren](http://mattwarren.org/2016/02/17/adventures-in-benchmarking-memory-allocations/)'ın blogundan erişebilirsiniz.